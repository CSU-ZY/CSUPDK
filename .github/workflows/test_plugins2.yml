---
# https://github.com/conda-incubator/setup-miniconda
name: Test plugins with mamba

on:
    pull_request:
    push:
    schedule:
        - cron: 0 2 * * * # run at 2 AM UTC

jobs:
    test:
        name: test plugins with mamba
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: conda-incubator/setup-miniconda@v2
              with:
                  python-version: 3.9
                  mamba-version: '*'
                  channels: conda-forge,defaults
                  channel-priority: true
                  activate-environment: anaconda-client-env
            - name: Add conda to system path
              run: |
                # $CONDA is an environment variable pointing to the root of the miniconda directory
                echo $CONDA/bin >> $GITHUB_PATH
            - shell: bash -l {0}
              run: |
                  conda info
                  conda list
                  conda config --show-sources
                  conda config --show
                  printenv | sort
            - shell: bash -l {0}
              run: |
                  mamba env update --name gdsfactory --file environment.yml
                  $CONDA/bin/pytest gdsfactory/simulation/meep
                  $CONDA/bin/pytest gdsfactory/simulation/mpb
